From 6639915df482bce969f87841c048627ae69a0eb3 Mon Sep 17 00:00:00 2001
From: Michael Natterer <mitch@gimp.org>
Date: Fri, 18 Jan 2013 15:47:29 +0100
Subject: [PATCH 29/29] quartz: add gdk_window_get_scale_factor()

which returns 1.0 normally and 2.0 on retina displays.
---
 gdk/gdkwindow.c               |   20 ++++++++++++++++++++
 gdk/gdkwindow.h               |    1 +
 gdk/gdkwindowimpl.h           |    3 +++
 gdk/quartz/gdkwindow-quartz.c |   17 +++++++++++++++++
 4 files changed, 41 insertions(+)

diff --git a/gdk/gdkwindow.c b/gdk/gdkwindow.c
index 68e4c70..4e080d1 100644
--- a/gdk/gdkwindow.c
+++ b/gdk/gdkwindow.c
@@ -11434,6 +11434,26 @@ gdk_window_get_height (GdkWindow *window)
   return height;
 }
 
+gdouble
+gdk_window_get_scale_factor (GdkWindow *window)
+{
+  GdkWindowObject *private;
+  GdkWindowImplIface *impl_iface;
+
+  g_return_val_if_fail (GDK_IS_WINDOW (window), 1.0);
+
+  private = (GdkWindowObject *) window;
+  if (private->destroyed)
+    return 1.0;
+
+  if (gdk_window_has_impl (private))
+    {
+      impl_iface = GDK_WINDOW_IMPL_GET_IFACE (private->impl);
+      return impl_iface->get_scale_factor (window);
+    }
+
+  return 1.0;
+}
 
 #define __GDK_WINDOW_C__
 #include "gdkaliasdef.c"
diff --git a/gdk/gdkwindow.h b/gdk/gdkwindow.h
index 572797b..95a3665 100644
--- a/gdk/gdkwindow.h
+++ b/gdk/gdkwindow.h
@@ -341,6 +341,7 @@ GdkDisplay*   gdk_window_get_display           (GdkWindow     *window);
 GdkVisual*    gdk_window_get_visual            (GdkWindow     *window);
 int           gdk_window_get_width             (GdkWindow     *window);
 int           gdk_window_get_height            (GdkWindow     *window);
+gdouble       gdk_window_get_scale_factor      (GdkWindow     *window);
 
 GdkWindow*    gdk_window_at_pointer            (gint          *win_x,
                                                 gint          *win_y);
diff --git a/gdk/gdkwindowimpl.h b/gdk/gdkwindowimpl.h
index 3a5029b..d6a0c89 100644
--- a/gdk/gdkwindowimpl.h
+++ b/gdk/gdkwindowimpl.h
@@ -146,6 +146,9 @@ struct _GdkWindowImplIface
   void         (* input_window_destroy) (GdkWindow       *window);
   void         (* input_window_crossing)(GdkWindow       *window,
 					 gboolean         enter);
+
+  gdouble      (* get_scale_factor)     (GdkWindow       *window);
+
   gboolean     supports_native_bg;
 };
 
diff --git a/gdk/quartz/gdkwindow-quartz.c b/gdk/quartz/gdkwindow-quartz.c
index a59c433..0bb5449 100644
--- a/gdk/quartz/gdkwindow-quartz.c
+++ b/gdk/quartz/gdkwindow-quartz.c
@@ -3194,6 +3194,22 @@ _gdk_windowing_window_get_input_shape (GdkWindow *window)
   return NULL;
 }
 
+static gdouble
+gdk_window_quartz_get_scale_factor (GdkWindow *window)
+{
+  GdkWindowImplQuartz *impl;
+
+  if (GDK_WINDOW_DESTROYED (window))
+    return 1.0;
+
+  impl = GDK_WINDOW_IMPL_QUARTZ (GDK_WINDOW_OBJECT (window)->impl);
+
+  if ([impl->toplevel respondsToSelector:@selector(backingScaleFactor)])
+    return [impl->toplevel backingScaleFactor];
+
+  return 1.0;
+}
+
 static void
 gdk_window_impl_iface_init (GdkWindowImplIface *iface)
 {
@@ -3222,4 +3238,5 @@ gdk_window_impl_iface_init (GdkWindowImplIface *iface)
   iface->destroy = _gdk_quartz_window_destroy;
   iface->input_window_destroy = _gdk_input_window_destroy;
   iface->input_window_crossing = _gdk_input_window_crossing;
+  iface->get_scale_factor = gdk_window_quartz_get_scale_factor;
 }
-- 
1.7.10.2 (Apple Git-33)

